<!DOCTYPE html>
<html>
<head>
	<title>AR.js and Three.js Example</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<script src="https://threejs.org/build/three.js"></script>
	<script src="https://raw.githack.com/jeromeetienne/AR.js/master/aframe/build/aframe-ar.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
	<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>
	<style>
		body {
			margin: 0;
			overflow: hidden;
			font-family: Monospace;
			background-color: #000;
			color: #fff;
		}
		#info {
			position: absolute;
			top: 0px;
			width: 100%;
			padding: 5px;
			font-size: 10pt;
			z-index: 100;
			text-align:center;
		}
	</style>
</head>
<body>
	<a-scene embedded arjs="debugUIEnabled: false; sourceType: webcam;">
		<a-camera-static position="0 0 0"></a-camera-static>
		<a-sphere position="0 0 -100" radius="0.05" color="#ff0000"></a-sphere>
		<a-entity id="satellite" gltf-model="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/AnimatedMorphCube/glTF/AnimatedMorphCube.gltf" scale="0.01 0.01 0.01"></a-entity>
		<a-text id="distanceText" position="0 0.3 -0.5" color="#ffffff" value=""></a-text>
	</a-scene>

	<div id="info">
		<p>Point your phone up to the sky to see a satellite.</p>
		<p id="locationText"></p>
	</div>

	<script>
		// get user location
		navigator.geolocation.getCurrentPosition(function(position) {
			var userLat = position.coords.latitude;
			var userLong = position.coords.longitude;
			// get ISS location
			fetch('https://api.wheretheiss.at/v1/satellites/25544')
				.then(response => response.json())
				.then(data => {
					var issLat = data.latitude;
					var issLong = data.longitude;
					// calculate distance between user and ISS
					var distance = calculateDistance(userLat, userLong, issLat, issLong);
					// display distance on the webpage
					document.getElementById("distanceText").setAttribute("value", "Distance to ISS: " + distance.toFixed(2) + " km");
				});
		});

		function calculateDistance(lat1, lon1, lat2, lon2) {
			var R = 6371; // km
			var dLat = (lat2-lat1) * Math.PI / 180;
			var dLon = (lon2-lon1) * Math.PI / 180
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
		  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
		  Math.sin(dLon/2) * Math.sin(dLon/2);
	    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
	    var d = R * c;
      return d;
	}

	// initialize Three.js scene
	var scene = new THREE.Scene();
	var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
	camera.position.z = 5;

	// load satellite model
	var loader = new THREE.GLTFLoader();
	loader.load('https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/AnimatedMorphCube/glTF/AnimatedMorphCube.gltf', function (gltf) {
		gltf.scene.position.set(0, 0, -10);
		scene.add(gltf.scene);
	});

	// initialize renderer and add to DOM
	var renderer = new THREE.WebGLRenderer({ alpha: true });
	renderer.setSize(window.innerWidth, window.innerHeight);
	document.body.appendChild(renderer.domElement);

	// animate satellite model
	function animate() {
		requestAnimationFrame(animate);
		scene.children[2].rotation.x += 0.01;
		scene.children[2].rotation.y += 0.01;
		renderer.render(scene, camera);
	}
	animate();

	// update location text
	function updateLocationText(lat, long) {
		document.getElementById("locationText").innerHTML = "Your location: " + lat.toFixed(2) + ", " + long.toFixed(2);
	}

	// listen for AR.js events
	document.querySelector('a-scene').addEventListener('gps-camera-update-position', function (event) {
		var lat = event.detail.position.latitude;
		var long = event.detail.position.longitude;
		updateLocationText(lat, long);
	});
</script>
